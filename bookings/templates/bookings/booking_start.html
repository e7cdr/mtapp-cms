{% extends 'base.html' %}
{% load static i18n wagtailimages_tags wagtailcore_tags custom_filters %}

{% block title %}Booking Form{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking_form.css'%}">
{% endblock %}
{% block content %}

<section class="booking-section">
    <div class="container">
        <h2>{% trans "Request Your Tour" %}</h2>
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div id="booking-form-container" data-duration="{{ tour_duration|default:0 }}">
            <form id="bookingForm" method="post"
                  action="{% url 'bookings:booking_start' tour.id|default:0 %}"
                  class="booking-form card">
                {% csrf_token %}

                <!-- Hidden inputs for tour_type and tour_id -->
                <input type="hidden" name="tour_type" value="{{ tour_type|default:'land' }}" id="id_tour_type">
                <input type="hidden" name="tour_id" value="{{ tour.id|default:0 }}" id="id_tour_id">
                <input type="hidden" name="form_submission" value="pricing">  <!-- Initial step -->
                <input type="hidden" name="selected_configuration" id="selected_configuration" value="0">
                <!-- Display form errors -->
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <ul>
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- Display tour selection warning or confirmation -->
                {% if not tour %}
                    <div class="alert alert-warning text-center">
                        {% trans "No tour selected. Please choose a tour from the tours page." %}
                        <a href="{% url 'tours_list' %}" class="btn btn-primary btn-sm ms-2">{% trans "View Tours" %}</a>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        {% trans "Selected Tour" %}: <strong>{{ tour.name|default:"Loading..." }}</strong>
                    </div>
                {% endif %}

                    <!-- Preferences Section -->
                    <div class="card" style="display: none">
                        <div class="card-header">
                            <h5>{% trans "Preferences" %}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.currency.id_for_label }}" class="form-label">{% trans "Currency" %}</label>
                                        {{ form.currency }}
                                        {% if form.currency.errors %}
                                            <div class="text-danger small">{{ form.currency.errors }}</div>
                                        {% endif %}
                                        <small class="text-muted">{% trans "Prices will be displayed and calculated in the selected currency." %}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Tour Information Section -->
                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Tour Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Column 1: Tour Image and Title -->
                            <div class="col-md-6">
                                <div class="tour-display">
                                    <div class="tour-image mb-3">
                                        {% if tour.cover_image %}
                                            {% image tour.cover_image fill-300x200 as tour_img %}
                                            <img src="{{ tour_img.url }}" class="tour-card-img" alt="{{ tour.name|default:'Tour Image' }}" loading="lazy">
                                        {% else %}
                                            <img src="{% static 'images/default_tour.jpg' %}" class="tour-card-img" alt="{% trans 'Default Tour Image' %}" loading="lazy">
                                        {% endif %}
                                    </div>
                                    <h6 class="tour-title" id="tourTitle">{{ tour.name|default:'Select a Tour' }}</h6>
                                </div>
                            </div>
                            <!-- Column 2: Travel Date, End Date, Estimated Price -->
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.travel_date.id_for_label }}" class="form-label">{% trans "Select Travel Start Date" %}</label>
                                    {{ form.travel_date }}
                                    {% if form.travel_date.errors %}
                                        <div class="text-danger small">{{ form.travel_date.errors }}</div>
                                    {% endif %}
                                    <div id="capacity-status" class="text-muted small mt-1"></div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="end_date" class="form-label">{% trans "Travel End Date" %}</label>
                                    <input type="text" class="form-control {% if tour_type == 'full' or tour_type == 'land' %}visible{% else %}d-none{% endif %}" id="end_date" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="additional_notes" class="form-label">Additional Notes</label>
                                    <p>{{tour.additional_notes|richtext}}</p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Section -->
                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Customer Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Column 1: Name, Email, Phone -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_name.id_for_label }}" class="form-label">{% trans "Name" %}</label>
                                    {{ form.customer_name }}
                                    {% if form.customer_name.errors %}
                                        <div class="text-danger small">{{ form.customer_name.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_email.id_for_label }}" class="form-label">{% trans "Email" %}</label>
                                    {{ form.customer_email }}
                                    {% if form.customer_email.errors %}
                                        <div class="text-danger small">{{ form.customer_email.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_phone.id_for_label }}" class="form-label">{% trans "Phone" %}</label>
                                    {{ form.customer_phone }}
                                    {% if form.customer_phone.errors %}
                                        <div class="text-danger small">{{ form.customer_phone.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.nationality.id_for_label }}" class="form-label">{% trans "Nationality" %}</label>
                                    {{ form.nationality }}
                                    {% if form.nationality.errors %}
                                        <div class="text-danger small">{{ form.nationality.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.number_of_adults.id_for_label }}" class="form-label">{% trans "Number of Adults" %}</label>
                                    {{ form.number_of_adults|default:1 }}
                                    {% if form.number_of_adults.errors %}
                                        <div class="text-danger small">{{ form.number_of_adults.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Column 2: Address, Nationality, Adults -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.number_of_children.id_for_label }}" class="form-label">{% trans "Number of Children" %}</label>
                                    {{ form.number_of_children }}
                                    {% if form.number_of_children.errors %}
                                        <div class="text-danger small">{{ form.number_of_children.errors }}</div>
                                    {% endif %}
                                </div>
                                    <div class="form-group mb-3 {% if not initial_children %}d-none{% endif %}" id="children-ages-group">
                                        <div id="child-ages-selects">
                                            {% include "bookings/partials/child_ages.html" with number_of_children=initial_children select_age_range=select_age_range child_ages=initial_child_ages %}
                                        </div>
                                        <!-- Hidden JSON for form submission -->
                                        <input type="hidden" name="child_ages" id="id_child_ages" value="{{ initial_child_ages_json|default:'[]' }}">
                                    </div>
                            </div>
                            <!-- Column 3: Children, Ages, Notes -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_address.id_for_label }}" class="form-label">{% trans "Address" %}</label>
                                    {{ form.customer_address }}
                                    {% if form.customer_address.errors %}
                                        <div class="text-danger small">{{ form.customer_address.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">{% trans "Notes" %}</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger small">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Pricing & Configurations" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="pricing-options">
                            <!-- Initial load: Empty or loading spinner -->
                            <div class="text-center py-4">
                                <p class="text-muted">{% trans "Update adults, children, or date to see pricing options." %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center captcha-section">
                    {% if form.captcha.errors %}
                        <p class="error text-danger">Invalid CAPTCHA. Try again.</p>
                    {% endif %}
                    <div class="captcha-wrapper d-inline-block text-center">
                        {{ form.captcha.label_tag }}  <!-- Math prompt, e.g., "3 + 5 = ?" -->
                        {{ form.captcha }}  <!-- Image + hidden + input -->
                        <button type="button" id="refresh-captcha" class="btn btn-sm btn-outline-secondary ms-2">Refresh Image</button>
                    </div>
                    <small class="text-muted d-block mt-2">Enter the math challenge above to verify you're human.</small>
                    <button type="button" id="submitProposal" class="btn btn-primary mt-3">{% trans "Submit Proposal" %}</button>
                </div>
                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmationModalLabel">{% trans "Confirm Your Proposal" %}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="confirmationContent">
                                <!-- Loaded dynamically -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                                <button type="button" id="confirmSubmit" class="btn btn-primary">{% trans "Confirm & Submit" %}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- JSON data for JavaScript -->
<script id="booking-data" type="application/json">
{
    "tourType": "{{ tour_type|escapejs }}",
    "tourId": "{{ tour.id|escapejs }}",
    "tourName": "{{ tour.name|escapejs }}",
    "languagePrefix": "{{ LANGUAGE_CODE|escapejs }}",
    "cancellationPolicy": "{{ tour.general_info|escapejs|truncatewords:20 }}",
    "tour_start_date": "{{ tour_start_date|escapejs }}",
    "tour_end_date": "{{ tour_end_date|escapejs }}",
    "available_days": "{{ available_days|escapejs }}"
}
</script>

<!-- Flatpickr CSS/JS (kept for date picker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'js/booking_form.js'%}"></script>




{% endblock %}