{% extends "base.html" %}
{% load static i18n wagtailimages_tags wagtailcore_tags custom_filters model_extras %}

{% block title %}Booking Form{% endblock title %}

{% block extra_css %}
<style>
    .navbar { position: relative; }
</style>
{% endblock extra_css %}

{% block content %}
<section class="booking-section">
    <div class="container">
        <h2>{% trans "Request Your Tour" %}</h2>
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div id="booking-form-container" data-duration="{{ tour_duration|default:0 }}">
            <form id="bookingForm" method="post"
                  action="{% url "bookings:booking_start" tour_type=tour_type tour_id=tour.id %}"
                  class="booking-form">
                {% csrf_token %}

                <!-- Hidden inputs for tour_type and tour_id -->
                <input type="hidden" name="tour_type" value="{{ tour_type|default:"land" }}" id="id_tour_type">
                <input type="hidden" name="tour_id" value="{{ tour.id|default:0 }}" id="id_tour_id">
                <input type="hidden" name="form_submission" value="pricing">  <!-- Initial step -->
                <input type="hidden" name="selected_configuration" id="selected_configuration" value="0">

                <!-- Display form errors (server-side fallback) -->
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <ul>
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- Display tour selection warning or confirmation -->
                {% if not tour %}
                    <div class="alert alert-warning text-center">
                        {% trans "No tour selected. Please choose a tour from the tours page." %}
                        <a href="{% url "tours_list" %}" class="btn btn-primary btn-sm ms-2">{% trans "View Tours" %}</a>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        {% trans "Selected Tour" %}: <strong>{{ tour.name|default:"Loading..." }}</strong>
                    </div>
                {% endif %}

                {% if tour.collect_price %}
                <div class="card" style="display: none">
                    <div class="card-header">
                        <h5>{% trans "Preferences" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.currency.id_for_label }}" class="form-label">{% trans "Currency" %}</label>
                                    {{ form.currency }}
                                    {% if form.currency.errors %}
                                        <div class="text-danger small">{{ form.currency.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted">{% trans "Prices will be displayed and calculated in the selected currency." %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tour Information Section -->
                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Tour Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Column 1: Tour Image and Title -->
                            <div class="col-md-6">
                                <div class="tour-display">
                                    <div class="tour-image mb-3">
                                        {% if tour.cover_image %}
                                            {% image tour.cover_image fill-300x200 format-webp as tour_img %}
                                            <img src="{{ tour_img.url }}" 
                                                 class="tour-card-img" 
                                                 alt="{{ tour.name|default:"Tour Image" }}" 
                                                 height=""
                                                 width=""
                                                 loading="lazy">
                                        {% else %}
                                            <img src="{% static "images/default_tour.jpg" %}" 
                                                 height=""
                                                 width=""
                                                 class="tour-card-img" alt="{% trans "Default Tour Image" %}" loading="lazy">
                                        {% endif %}
                                    </div>
                                    <h6 class="tour-title" id="tourTitle">{{ tour.name|default:"Select a Tour" }}</h6>
                                </div>
                            </div>
                            <!-- Column 2: Travel Date, End Date, Estimated Price -->
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.travel_date.id_for_label }}" class="form-label">{% trans "Select Travel Start Date" %}</label>
                                    <input type="text" name="travel_date" 
                                           class="form-control flatpickr-input" 
                                           id="{{ form.travel_date.id_for_label }}"
                                           required 
                                           data-error-required="{% trans "Please select a travel start date." %}"
                                           data-error-invalid="{% trans "This date is not available or outside the tour period." %}">
                                    <div class="invalid-feedback"></div>
                                    <div id="capacity-status" class="text-muted small mt-1"></div>
                                    {% if form.travel_date.errors %}
                                        <div class="text-danger small">{{ form.travel_date.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="end_date" class="form-label">{% trans "Travel End Date" %}</label>
                                    <input type="text" class="form-control {% if tour_type == "full" or tour_type == "land" %}visible{% else %}d-none{% endif %}" 
                                           id="end_date" name="end_date" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="additional_notes" class="form-label">{% trans "Additional Notes" %}</label>
                                    <p>{{ tour.additional_notes|richtext }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Section -->
                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Customer Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Column 1: Name, Email, Phone -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.number_of_adults.id_for_label }}" class="form-label">{% trans "Number of Adults" %}</label>
                                    <input type="number" name="number_of_adults" 
                                           class="form-control" 
                                           id="{{ form.number_of_adults.id_for_label }}"
                                           min="1" required 
                                           value="{{ form.number_of_adults.value|default:1 }}"
                                           data-error-min="{% trans "At least 1 adult is required." %}"
                                           data-error-required="{% trans "This field is required." %}">
                                    <div class="invalid-feedback"></div>
                                    {% if form.number_of_adults.errors %}
                                        <div class="text-danger small">{{ form.number_of_adults.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_name.id_for_label }}" class="form-label">{% trans "Name" %}</label>
                                    <input type="text" name="customer_name" 
                                           class="form-control" 
                                           id="{{ form.customer_name.id_for_label }}"
                                           required 
                                           data-error-required="{% trans "Please enter your name." %}">
                                    <div class="invalid-feedback"></div>
                                    {% if form.customer_name.errors %}
                                        <div class="text-danger small">{{ form.customer_name.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_email.id_for_label }}" class="form-label">{% trans "Email" %}</label>
                                    <input type="email" name="customer_email" 
                                           class="form-control" 
                                           id="{{ form.customer_email.id_for_label }}"
                                           required 
                                           data-error-required="{% trans "Please enter a valid email address." %}"
                                           data-error-type="{% trans "Please enter a valid email address." %}">
                                    <div class="invalid-feedback"></div>
                                    {% if form.customer_email.errors %}
                                        <div class="text-danger small">{{ form.customer_email.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_phone.id_for_label }}" class="form-label">{% trans "Phone" %}</label>
                                    <input type="tel" name="customer_phone" 
                                           class="form-control" 
                                           id="{{ form.customer_phone.id_for_label }}"
                                           required 
                                           data-error-required="{% trans "Please enter a phone number." %}">
                                    <div class="invalid-feedback"></div>
                                    {% if form.customer_phone.errors %}
                                        <div class="text-danger small">{{ form.customer_phone.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            <div class="form-group mb-3">
                                <label for="{{ form.nationality.id_for_label }}" class="form-label">
                                    {% trans "Nationality" %}
                                </label>
                                
                                {{ form.nationality }}
                                
                                <div class="invalid-feedback"></div>
                                {% if form.nationality.errors %}
                                    <div class="text-danger small">{{ form.nationality.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            </div>
                            <!-- Column 2: Address, Children -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.number_of_children.id_for_label }}" class="form-label">{% trans "Number of Children" %}</label>
                                    <input type="number" name="number_of_children" 
                                           class="form-control" 
                                           id="{{ form.number_of_children.id_for_label }}"
                                           min="0" 
                                           value="{{ form.number_of_children.value|default:0 }}">
                                    <div class="invalid-feedback"></div>
                                    {% if form.number_of_children.errors %}
                                        <div class="text-danger small">{{ form.number_of_children.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3 {% if not initial_children %}d-none{% endif %}" id="children-ages-group">
                                    <div id="child-ages-selects">
                                        {% include "bookings/partials/child_ages.html" with number_of_children=initial_children select_age_range=select_age_range child_ages=initial_child_ages %}
                                    </div>
                                </div>
                            </div>
                            <!-- Column 3: Address, Notes -->
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.customer_address.id_for_label }}" class="form-label">{% trans "Address" %}</label>
                                    <input type="text" name="customer_address" 
                                           class="form-control" 
                                           id="{{ form.customer_address.id_for_label }}">
                                    {% if form.customer_address.errors %}
                                        <div class="text-danger small">{{ form.customer_address.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">{% trans "Notes" %}</label>
                                    <textarea name="notes" class="form-control" id="{{ form.notes.id_for_label }}" rows="3"></textarea>
                                    {% if form.notes.errors %}
                                        <div class="text-danger small">{{ form.notes.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Section (unchanged) -->
                {% if tour.collect_price %}
                <div class="card">
                    <div class="card-header">
                        <h5>{% trans "Pricing & Configurations" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="pricing-options">
                            <!-- Initial load: Empty or loading spinner -->
                            <div class="text-center py-4">
                                <p class="text-muted">{% trans "Update adults, children, or date to see pricing options." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card border-info mb-4">
                    <div class="card-body text-center py-5 bg-light">
                        <i class="fas fa-envelope-open-text fa-3x text-info mb-3"></i>
                        <h5 class="text-info">{{ tour|verbose_name:"inquiry_message" }}:</h5>
                        <p class="lead mb-0">
                            {{ tour.inquiry_message|richtext }}
                        </p>
                    </div>
                </div>
                {% endif %}

                <!-- CAPTCHA & Submit -->
                <div class="text-center captcha-section">
                    {% if form.captcha.errors %}
                        <p class="error text-danger">Invalid CAPTCHA. Try again.</p>
                    {% endif %}
                    <div class="captcha-wrapper d-inline-block text-center">
                        {{ form.captcha.label_tag }}
                        {{ form.captcha }}
                        <button type="button" id="refresh-captcha" class="btn btn-sm btn-outline-secondary ms-2">Refresh Image</button>
                    </div>
                    <small class="text-muted d-block mt-2">Enter the math challenge above to verify you"re human.</small>
                    <button type="button" id="submitProposal" class="btn btn-primary mt-3">{% trans "Submit Proposal" %}</button>
                </div>

                <!-- Confirmation Modal (unchanged) -->
                <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmationModalLabel">{% trans "Confirm Your Proposal" %}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="confirmationContent">
                                <!-- Loaded dynamically -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                                <button type="button" id="confirmSubmit" class="btn btn-primary">{% trans "Confirm & Submit" %}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock content %}

{% block extra_js %}
<script src="{% static "js/booking_form.js" %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const bookingData = {{ booking_data_json|safe }};

        // 1. Smart default date
        let defaultDate = null;
        if (bookingData.tour_start_date && bookingData.tour_start_date > new Date().toISOString().split("T")[0]) {
            defaultDate = bookingData.tour_start_date;
        } else if (bookingData.fixed_date) {
            defaultDate = bookingData.fixed_date;
        } else {
            defaultDate = new Date().toISOString().split("T")[0];
        }

        // 2. Define the onChange handler
        const calculateEndDate = function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 0) return;

            const start = selectedDates[0];
            const durationDays = {{ tour.duration_days|default:1 }};

            const end = new Date(start);
            end.setDate(end.getDate() + durationDays - 1);

            const endDateInput = document.getElementById("end_date");
            if (endDateInput) {
                endDateInput.value = end.toISOString().split("T")[0];
            }
        };

        // 3. Initialize Flatpickr
        const fp = flatpickr("#id_travel_date", {
            dateFormat: "Y-m-d",
            defaultDate: defaultDate,
            minDate: bookingData.tour_start_date || "today",
            maxDate: bookingData.tour_end_date || null,
            disableMobile: true,
            disable: [
                {% for date_str in tour.blackout_dates_list %}
                    "{{ date_str }}",
                {% empty %}
                    // no blackout dates
                {% endfor %}
            ],
            {% if tour.available_days %}
            enable: [
                function(date) {
                    const allowedDays = [{% for day in tour.available_days %} {{ day }} {% if not forloop.last %}, {% endif %}{% endfor %}];
                    return allowedDays.includes(date.getDay());
                }
            ],
            {% endif %}
            onChange: calculateEndDate
        });

        // 4. Manually trigger for default date
        if (fp.selectedDates.length > 0) {
            calculateEndDate(fp.selectedDates, fp.input.value, fp);
        }
    });
</script>

<!-- Client-side validation -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("bookingForm");

    // Submit validation
    form.addEventListener("submit", function(e) {
        let valid = true;

        form.querySelectorAll("input[required], select[required]").forEach(input => {
            if (!input.checkValidity()) {
                input.classList.add("is-invalid");
                const feedback = input.nextElementSibling;
                if (feedback && feedback.classList.contains("invalid-feedback")) {
                    feedback.textContent = input.dataset.errorRequired || input.validationMessage;
                }
                valid = false;
            } else {
                input.classList.remove("is-invalid");
            }
        });

        if (!valid) {
            e.preventDefault();
            form.querySelector(".is-invalid")?.focus();
        }
    });

    // Real-time validation
    form.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("blur", validateField);
        input.addEventListener("change", validateField);
    });

    function validateField() {
        if (this.checkValidity()) {
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
        } else {
            this.classList.remove("is-valid");
            this.classList.add("is-invalid");
            const feedback = this.nextElementSibling;
            if (feedback && feedback.classList.contains("invalid-feedback")) {
                feedback.textContent = this.dataset.errorRequired || this.validationMessage;
            }
        }
    }
});
</script>
{% endblock extra_js %}