{% extends "base.html" %} {% load static i18n tour_filters custom_filters wagtailcore_tags wagtailimages_tags %}
{% block title %}{{ self.title }}
{% endblock title %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/detail_page.css' %}" />
<body>
 <div class="detail-container">
  <div class="cover-image-container">
   <div class="cover-image">
    {% image self.cover_image original as img %}
    <img src="{{ img.url }}" alt="Tour cover image" loading="lazy" height="" width="" />
   </div>
   <div class="cover-text">
    <h1>{{ self.name }}</h1>
    <h2 class="cover-text-duration">
     {% if self.duration_days > 1 %}{{ self.duration_days }} days,{% else %}{{ self.duration_days }} day {% endif %}
     {% if not self.duration_days == 1 %}{{ self.nights }} nights
     {% endif %}
    </h2>
    <a href="{{ self.yt_vid }}" class="book-button conic-gradient-animation">Tour Video</a>
    {% comment %}
    <div class="tour-itinerary">View PDF Itinerary</div>
    {% endcomment %}
    <br />
    {% if not self.is_sold_out %}
    <div class="booking-actions">
     <a href="{% url 'bookings:booking_start' self.id %}" class="book-button conic-gradient-animation"> Book Now </a>
     <a href="https://api.whatsapp.com/send/?phone=593967359549&text=Hello%2C+I+am+interested+in+{{ self.name }}+from+your+webpage&type=phone_number&app_absent=0"
      class="book-button secondary">
      WhatsApp
     </a>
    </div>
    {% if self.disclaimer %}
    <p class="disclaimer">
      {{ self.disclaimer|richtext }}
    </p>
      {% endif %}
      {% else %}
    <button class="book-button disabled">Sold Out</button>
    {% endif %}
   </div>
   <div class="flex-container">
    {% if self.is_sold_out %}
    <div class="stickers sticker-1">SOLD OUT</div>
    {% endif %} {% if self.is_special_offer %}
    <div class="stickers sticker-2">Special Offer</div>
    {% endif %}
   </div>
  </div>
  <div class="data-container">
   <div class="tab-section">
    <div>
     <div class="tab-card">
      <nav class="section-nav">
       <ul id="tourTabs" role="tablist">
        <li class="nav-item" role="presentation">
         <a
          class="nav-link active"
          id="description-tab"
          data-bs-toggle="tab"
          href="#description"
          role="tab"
          aria-selected="true"
          >Description</a
         >
        </li>

        <li class="nav-item" role="presentation">
         <a
          class="nav-link"
          id="itinerary-tab"
          data-bs-toggle="tab"
          href="#itinerary"
          role="tab"
          aria-selected="false"
          tabindex="-1"
          >Itinerary</a
         >
        </li>
        <li class="nav-item" role="presentation">
         <a class="nav-link" id="notes-tab" data-bs-toggle="tab" href="#notes" role="tab" aria-selected="false" tabindex="-1"
          >Additional Notes</a
         >
        </li>
        {% if not self.pricing_table == False %}
        <li class="nav-item" role="presentation">
         <a
          class="nav-link"
          id="pricing-tab"
          data-bs-toggle="tab"
          href="#pricing"
          role="tab"
          aria-selected="false"
          tabindex="-1"
          >Pricing &amp; Details</a
         >
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
         <a
          class="nav-link"
          id="cxl-policy-tab"
          data-bs-toggle="tab"
          href="#cxl-policy"
          role="tab"
          aria-selected="false"
          tabindex="-1"
          >Cancellation Policy</a
         >
        </li>
       </ul>
      </nav>
      <hr />
      <div class="tab-content">
       <!-- Description -->
       <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
        {% for block in page.description_content %}
        {% include_block block %}
        {% endfor %}
        <p id="tour-id">{{ self.description|richtext }}</p>
        <p><strong>Destination:</strong> {{ self.destination }}</p>
        <p><strong>Hotel:</strong> {{ self.hotel }}</p>
        <p><strong>Dates:</strong> {{ self.start_date }} - {{ self.end_date }}</p>
        <p>{{ self.no_inclusions|richtext }}</p>

      <!-- Amenities -->
       {% if self.amenity %}
       <h2>Amenities</h2>
       <div aria-labelledby="amenities">
        {% if amenity_labels %}
        <ul>
         {% for label in amenity_labels %}
         <li>{{ label }}</li>
         {% endfor %}
        </ul>
        {% else %}
        <p>No amenities.</p>
        {% endif %} {% endif %}
       </div>
    </div>
        <!-- Optional Activities -->
        <div class="tab-pane fade hidden" id="notes" role="tabpanel" aria-labelledby="notes-tab">
        <p>{{ self.additional_notes|richtext }}</p>
        </div>

      <!-- Itinerary -->
      <div class="tab-pane fade hidden" id="itinerary" role="tabpanel" aria-labelledby="itinerary-tab">
          <nav class="section-nav">
              <ul id="itinerary-days" role="tablist">
                  {% for block in self.itinerary %}
                  <li class="nav-item" role="presentation">
                      <a
                          class="nav-link {% if forloop.first %}active{% endif %}"
                          id="day-{{ block.value.day }}-tab"
                          data-bs-toggle="tab"
                          href="#day-{{ block.value.day }}"
                          role="tab"
                          aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                          tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
                          >Day {{ block.value.day }}</a>
                  </li>
                  {% endfor %}
              </ul>
          </nav>
          <hr />
          <div class="tab-content">
              {% for block in self.itinerary %}
              <div
                  class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                  id="day-{{ block.value.day }}"
                  role="tabpanel"
                  aria-labelledby="day-{{ block.value.day }}-tab"
              >
                  <h3>Day {{ block.value.day }}</h3>
                  <p>{{ block.value.description }}</p>
                  <h4>Highlights</h4>
                  <ul>
                      {{ block.value.highlight|richtext }}
                  </ul>
              </div>
              {% endfor %}
          </div>
      </div>

       <!-- Flight Details -->
        {% if not self.pricing_table == False %}
        <!-- Pricing & Details -->
            <div class="tab-pane fade hidden" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
            {% if self.show_prices_in_table %}
                    <!-- Custom RichText Message -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-8 text-center shadow-lg">
                        <div class="prose prose-lg max-w-none text-amber-900 leading-relaxed text-center">
                            {{ self.show_prices_in_table|richtext }}
                        </div>
                        <div class="mt-8">
                            <a href="{{ self.button_link }}"
                            class="inline-flex items-center px-8 py-4 bg-amber-600 hover:bg-amber-700 text-white font-bold text-lg rounded-full shadow-xl transition transform hover:scale-105">
                                {{ self.button_text }}
                            </a>
                        </div>
                    </div>
                {% else %}
            <!-- DYNAMIC PRICING TABLE -->
            <div class="overflow-hidden rounded-2xl shadow-xl border border-gray-100">
                <table class="pricing-table w-full">
                    <thead>
                        <tr class="bg-gradient-to-r from-indigo-600 to-purple-700">
                            <th scope="col" class="text-left text-white uppercase tracking-wider">Category</th>
                            <th scope="col" class="text-left text-white uppercase tracking-wider">Price</th>
                            <th scope="col" class="text-left text-white uppercase tracking-wider">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">

                        <!-- Duration -->
                        <tr class="hover:bg-indigo-50/50 transition-all duration-300">
                            <th class="font-semibold text-gray-800">Duration</th>
                            <td colspan="2">
                                {{ self.duration_days }} day{% if self.duration_days > 1 %}s{% endif %}
                                {% if self.nights > 0 %}, {{ self.nights }} night{% if self.nights > 1 %}s{% endif %}{% endif %}
                            </td>
                        </tr>

                        <!-- Status Badges -->
                        <tr class="hover:bg-rose-50/50 transition-all duration-300">
                            <th class="font-semibold text-gray-800">Status</th>
                            <td colspan="2">
                                {% if self.is_sold_out %}
                                    <span class="inline-block px-4 py-2 bg-red-600 text-white rounded-full text-sm font-bold animate-pulse">SOLD OUT</span>
                                {% endif %}
                                {% if self.is_special_offer and not self.is_sold_out %}
                                    <span class="inline-block px-4 py-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full text-sm font-bold shadow-md">
                                        Special Offer
                                    </span>
                                {% endif %}
                                {% if self.is_on_discount %}
                                    <span class="inline-block px-4 py-2 bg-emerald-600 text-white rounded-full text-sm font-bold">
                                        On Sale
                                    </span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- COMBINED PRICING TIERS — THE STAR -->
                        {% if self.pricing_type == "Combined" and self.combined_pricing_tiers %}
                            {% for block in self.combined_pricing_tiers %}
                                {% with tier=block.value %}
                                <tr class="hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 transition-all duration-500 group">
                                    <th class="font-bold text-purple-700 group-hover:text-purple-900">
                                        {% if forloop.first %}
                                            Price per Adult
                                        {% else %}
                                            {{ tier.min_pax }}{% if tier.max_pax %}–{{ tier.max_pax }}{% else %}+{% endif %} Adults
                                        {% endif %}
                                    </th>
                                    <td class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                                        ${{ tier.price_adult }} USD
                                        {% if not forloop.first and tier.price_dbl_discount > 0 %}
                                            <span class="block text-sm font-normal text-green-600 mt-1">
                                                Save ${{ tier.price_dbl_discount|floatformat:0 }} in double!
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-sm text-gray-600 italic">
                                        Child: {{ tier.child_price_percent }}% • 
                                        Infant: 
                                        {% if tier.infant_price_type == 'free' %}Free
                                        {% elif tier.infant_price_type == 'percent' %}{{ tier.infant_percent_of_adult }}% of adult
                                        {% else %}${{ tier.infant_fixed_amount }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endwith %}
                            {% endfor %}

                        <!-- PER PERSON PRICING -->
                        {% elif self.pricing_type == "Per_person" and self.price_adult > 0 %}
                            <tr class="hover:bg-emerald-50 transition-all duration-300">
                                <th class="font-bold text-emerald-700">Price per Person</th>
                                <td class="text-2xl font-extrabold text-emerald-600">
                                    ${{ self.price_adult }} USD
                                </td>
                                <td class="text-gray-600">{{ self.price_subtext|default:"" }}</td>
                            </tr>

                        <!-- PER ROOM PRICING -->
                        {% else %}
                            {% if self.price_sgl > 0 %}
                            <tr class="hover:bg-indigo-50 transition-all duration-300">
                                <th class="font-semibold text-indigo-700">Single Room</th>
                                <td class="text-xl font-bold text-indigo-600">${{ self.price_sgl }} USD</td>
                                <td></td>
                            </tr>
                            {% endif %}
                            {% if self.price_dbl > 0 %}
                            <tr class="hover:bg-purple-50 transition-all duration-300">
                                <th class="font-semibold text-purple-700">Double Room</th>
                                <td class="text-xl font-bold text-purple-600">${{ self.price_dbl }} USD</td>
                                <td class="text-green-600 font-medium">Best value</td>
                            </tr>
                            {% endif %}
                            {% if self.price_tpl > 0 %}
                            <tr class="hover:bg-rose-50 transition-all duration-300">
                                <th class="font-semibold text-rose-700">Triple Room</th>
                                <td class="text-xl font-bold text-rose-600">${{ self.price_tpl }} USD</td>
                                <td></td>
                            </tr>
                            {% endif %}
                        {% endif %}

                        <!-- Child & Infant (Only if relevant) -->
                        {% if self.price_chd > 0 or self.pricing_type == "Combined" %}
                            <tr class="hover:bg-yellow-50/50 transition-all duration-300">
                                <th class="font-semibold text-amber-700">Child Rate</th>
                                <td>
                                    {% if self.pricing_type == "Combined" %}
                                        <span class="text-amber-700 font-bold">See tier above</span>
                                    {% else %}
                                        ${{ self.price_chd }} USD
                                    {% endif %}
                                </td>
                                <td>Ages {{ self.child_age_min }}–{{ self.child_age_max }}</td>
                            </tr>
                        {% endif %}

                        {% if self.price_inf > 0 or self.pricing_type == "Combined" %}
                            <tr class="hover:bg-sky-50/50 transition-all duration-300">
                                <th class="font-semibold text-sky-700">Infant</th>
                                <td>
                                    {% if self.pricing_type == "Combined" %}
                                        <span class="text-sky-700 font-bold">See tier above</span>
                                    {% else %}
                                        ${{ self.price_inf|default:"Free" }} USD
                                    {% endif %}
                                </td>
                                <td>Under {{ self.child_age_min }} years</td>
                            </tr>
                        {% endif %}

                        <!-- Currency -->
                        <tr class="bg-gray-50">
                            <th class="font-semibold text-gray-700">Currency</th>
                            <td colspan="2" class="font-bold text-gray-800">United States Dollar (USD)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pro Tip -->
            <div class="mt-8 text-center">
                <p class="text-sm text-gray-600 italic">
                    Prices are per person • Final quote includes all taxes & fees • 
                    <span class="font-semibold text-indigo-600">Book now for best availability</span>
                </p>
            </div>
        {% endif %}
    </div>
    {% endif %}
       <!-- Cancellation Policies -->
       <div class="tab-pane fade hidden" id="cxl-policy" role="tabpanel" aria-labelledby="cxl-policy-tab">
        {% if self.cxl_policies %}
            {{ self.cxl_policies|richtext }}
        {% else %}
            <p>No Cancellation policies specified.</p>
        {% endif %}
       </div>
       <!-- Cancellation Policy -->
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
</body>

<script src="{% static 'js/tour_detail.js' %}"></script>
{% endblock content %}
