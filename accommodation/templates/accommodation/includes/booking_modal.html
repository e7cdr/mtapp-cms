{% load static i18n countries %}

<link rel="stylesheet" href="{% static 'css/acc_bookingModal.css' %}"/>

<div id="bookingModal" class="booking-modal" role="dialog" aria-modal="true" aria-labelledby="bookingModalTitle">
  <div class="booking-modal-overlay" data-close-modal></div>
  
  <div class="booking-modal-content">
    <button class="booking-modal-close" aria-label="{% trans 'Close' %}" data-close-modal>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>

    <div class="booking-modal-header">
      <h2 id="bookingModalTitle" class="booking-modal-title">
        {% trans "Book" %}: <span id="modalAccommodationName">{{ page.name }}</span>
      </h2>
      <p class="booking-modal-subtitle">
        {{ page.location }}, {{ page.destination }}
      </p>
    </div>

    <div class="booking-modal-body">
      <form id="accommodationBookingForm" 
            action="{% url 'accommodation:accommodation_booking' page.id %}" 
            method="post" 
            novalidate>
        {% csrf_token %}
        <input type="hidden" name="accommodation_id" value="{{ page.id }}">
        <input type="hidden" name="child_ages" id="child_ages" value="[]">

        <div class="form-grid">
          <div class="form-group">
            <label for="check_in">{% trans "Check-in" %}</label>
            <input type="text" id="check_in" name="check_in" required class="flatpickr-input" readonly>
          </div>
          <div class="form-group">
            <label for="check_out">{% trans "Check-out" %}</label>
            <input type="text" id="check_out" name="check_out" required class="flatpickr-input" readonly>
          </div>

          <div class="form-group">
            <label for="adults">{% trans "Adults" %}</label>
            <select id="adults" name="adults" required>
              {% for i in "12345678"|make_list %}
                <option value="{{ forloop.counter }}" {% if forloop.counter == 2 %}selected{% endif %}>
                  {{ forloop.counter }} {% trans "Adult" %}{% if forloop.counter > 1 %}s{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="children">{% trans "Children" %} <small>(0–12)</small></label>
            <select id="children" name="children">
              {% for i in "0123456"|make_list %}
                <option value="{{ forloop.counter0 }}">{{ forloop.counter0 }} {% trans "Children" %}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div id="childAgesContainer" class="mt-4"></div>

        <div class="form-grid mt-4">
          <div class="form-group">
            <label>{% trans "Full Name" %} <span class="text-red-600">*</span></label>
            <input type="text" name="name" required class="w-full" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label>{% trans "Email" %} <span class="text-red-600">*</span></label>
            <input type="email" name="email" required class="w-full" placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label>{% trans "Phone" %}</label>
            <input type="tel" name="phone" class="w-full" placeholder="+593 99 999 9999">
          </div>
          <div class="form-group">
              <label for="{{ form.country.id_for_label }}" class="form-label">
                  {% trans "Country" %}
              </label>
              
              {{ form.country }}
              
              <div class="invalid-feedback"></div>
              {% if form.country.errors %}
                  <div class="text-danger small">{{ form.country.errors|join:", " }}</div>
              {% endif %}
          </div>
           <div class="form-group">
            <label>{% trans "Special Requests" %}</label>
            <textarea name="notes" rows="3" class="w-full"></textarea>
          </div>
        </div>

        <!-- LIVE PRICE -->
        <div class="price-summary mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border">
          <div class="text-lg font-semibold">
            {% trans "Total to Pay" %}:
            <span id="totalPrice" class="text-2xl text-green-600 dark:text-green-400">$0.00</span>
            <span class="text-sm text-gray-600 dark:text-gray-400">USD</span>
          </div>
          <div id="nightsInfo" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></div>
        </div>

        <div class="form-actions mt-6">
          <button type="submit" id="submitBookingBtn" class="btn-primary w-full">
            <span class="text">{% trans "Continue to Payment" %}</span>
            <span class="loading hidden">{% trans "Processing..." %}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('bookingModal');
    const openButtons = document.querySelectorAll('[data-open-booking-modal]');
    const closeTriggers = document.querySelectorAll('[data-close-modal]');
    const form = document.getElementById('accommodationBookingForm');
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const adultsSelect = document.getElementById('adults');
    const childrenSelect = document.getElementById('children');
    const childAgesContainer = document.getElementById('childAgesContainer');
    const totalPriceEl = document.getElementById('totalPrice');
    const nightsInfoEl = document.getElementById('nightsInfo');

    const PAGE_ID = {{ page.id }};

    let checkInPicker, checkOutPicker;

    openButtons.forEach(btn => btn.addEventListener('click', e => {
      e.preventDefault();
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      if (!checkInPicker) {
        checkInPicker = flatpickr(checkInInput, {
          minDate: "today",
          dateFormat: "Y-m-d",
          disable: [
            date => {{ page.blocked_dates_list|safe }}.includes(date.toISOString().split('T')[0]),
            date => {
              const days = {{ page.available_days_list|safe }};
              return days.length > 0 && !days.includes(date.getDay());
            }
          ],
          onChange: () => updatePrice()
        });

        checkOutPicker = flatpickr(checkOutInput, {
          minDate: "today",
          dateFormat: "Y-m-d",
          disable: [
            date => {{ page.blocked_dates_list|safe }}.includes(date.toISOString().split('T')[0]),
            date => {
              const days = {{ page.available_days_list|safe }};
              return days.length > 0 && !days.includes(date.getDay());
            }
          ],
          onChange: () => updatePrice()
        });
      }

      checkInPicker.clear();
      checkOutPicker.clear();
      totalPriceEl.textContent = '$0.00';
      nightsInfoEl.textContent = '';
    }));

    const closeModal = () => {
      modal.classList.remove('active');
      document.body.style.overflow = '';
      form?.reset();
      childAgesContainer.innerHTML = '';
      totalPriceEl.textContent = '$0.00';
      nightsInfoEl.textContent = '';
    };

    closeTriggers.forEach(el => el.addEventListener('click', closeModal));
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
    });

  childrenSelect?.addEventListener('change', () => {
    const count = parseInt(childrenSelect.value) || 0;
    childAgesContainer.innerHTML = '';
    for (let i = 1; i <= count; i++) {
      childAgesContainer.innerHTML += `
        <div class="form-group">
          <label>{% trans "Child" %} ${i} {% trans "Age" %}</label>
          <select id="child_age_${i}" name="child_age_${i}" required class="w-full">
            ${Array.from({length: 13}, (_, a) => 
              `<option value="${a}" ${a === 7 ? 'selected' : ''}>${a} {% trans "years" %}</option>`
            ).join('')}
          </select>
        </div>
      `;

      // ADD THIS LINE — UPDATE PRICE WHEN AGE CHANGES
      document.getElementById(`child_age_${i}`).addEventListener('change', updatePrice);
    }
    updateChildAges();
    updatePrice(); // update immediately
  });

  function updateChildAges() {
    const count = parseInt(childrenSelect.value) || 0;
    const ages = [];
    for (let i = 1; i <= count; i++) {
      const select = document.getElementById(`child_age_${i}`);
      if (!select) {
        console.error(`Missing child_age_${i}`);
        return;
      }
      const age = parseInt(select.value);
      if (isNaN(age)) {
        console.error(`Invalid age for child ${i}`);
        return;
      }
      ages.push(age);
    }
    document.getElementById('child_ages').value = JSON.stringify(ages);
  }
  
  async function updatePrice() {
    const checkIn = checkInInput.value;
    const checkOut = checkOutInput.value;
    const adults = parseInt(adultsSelect.value) || 0;
    const children = parseInt(childrenSelect.value) || 0;

    if (!checkIn || !checkOut || adults === 0) {
      totalPriceEl.textContent = '$0.00';
      nightsInfoEl.textContent = '';
      return;
    }

    const nights = Math.round((new Date(checkOut) - new Date(checkIn)) / 86400000);
    if (nights <= 0) return;

    // Collect current ages — same logic as submit
    const ages = [];
    for (let i = 1; i <= children; i++) {
      const select = document.getElementById(`child_age_${i}`);
      if (select) {
        ages.push(parseInt(select.value) || 0);
      }
    }

    try {
      const params = new URLSearchParams({
        check_in: checkIn,
        check_out: checkOut,
        adults: adults,
        children: children,
        child_ages: JSON.stringify(ages)
      });

      const res = await fetch(`/accommodations/${PAGE_ID}/price-preview/?${params}`);
      const data = await res.json();
      totalPriceEl.textContent = `$${data.total.toFixed(2)}`;
      nightsInfoEl.textContent = `${nights} night${nights > 1 ? 's' : ''}`;
    } catch (e) {
      totalPriceEl.textContent = '—';
      nightsInfoEl.textContent = '';
    }
  }

    [checkInInput, checkOutInput, adultsSelect, childrenSelect].forEach(el => {
      el?.addEventListener('change', updatePrice);
    });

    form?.addEventListener('submit', async e => {
      e.preventDefault();
      updateChildAges();  // ← Collect ages right before submit
      const submitBtn = document.getElementById('submitBookingBtn');
      const text = submitBtn.querySelector('.text');
      const loading = submitBtn.querySelector('.loading');

      text.classList.add('hidden');
      loading.classList.remove('hidden');
      submitBtn.disabled = true;

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();

        if (data.success && data.redirect_url) {
          window.location.href = data.redirect_url;
        } else {
  // Reset previous errors
  document.querySelectorAll('.text-danger.field-error').forEach(el => el.remove());
  document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

  let hasShownAlert = false;

  for (const field in data.errors) {
    const messages = data.errors[field];
    const input = form.querySelector(`[name="${field}"]`);

    if (input) {
      // Add Bootstrap invalid class
      input.classList.add('is-invalid');

      // Create error message element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'text-danger small field-error mt-1';
      errorDiv.textContent = messages.join(', ');
      input.parentElement.appendChild(errorDiv);
        } else {
          // Fallback for hidden/special fields or if input not found
          if (!hasShownAlert) {
            let msg = "{% trans 'Please fix the following:' %}\n\n";
            for (const f in data.errors) {
              msg += `• ${f}: ${data.errors[f].join(', ')}\n`;
            }
            alert(msg);
            hasShownAlert = true;
          }
        }
      }

      text.classList.remove('hidden');
      loading.classList.add('hidden');
      submitBtn.disabled = false;
    }
      } catch (err) {
        alert("{% trans 'Connection failed. Try again.' %}");
        text.classList.remove('hidden');
        loading.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });
  });
</script>