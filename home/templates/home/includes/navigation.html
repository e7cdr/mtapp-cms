
{% load static i18n dict_tags navbar_tags wagtailcore_tags wagtailadmin_tags lang_filters %}

{% get_navbar_pages as navbar_pages %}
{% get_staff_pages as staff_pages %}
{% get_tour_pages as tour_pages %}
{% wagtail_site as current_site %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/navbar.css' %}" />
{% endblock %}

<header>
  <nav class="navbar">
    <a href="/">
      <img src="{% static 'default_media/logo.png' %}" alt="navbar-logo" class="navbar-logo"/>
      <form action="{% url 'set_language' %}" method="post" id="languageForm" class="lang-toggle">
          {% csrf_token %}
          <input type="hidden" name="language" id="languageInput">
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="button" id="languageToggle" aria-label="{% trans 'Toggle Language' %}">
              {% comment %} <i class="bi bi-globe"></i> {% endcomment %}
              <span id="currentLang">
                  {% load lang_filters %}  <!-- Load your custom filter; adjust app name if needed -->
                  {% get_language_info for LANGUAGE_CODE as lang %}
              <span id="flagIcon" class="fi fi-{{ LANGUAGE_CODE|language_to_flag }}" aria-hidden="true"></span>
              {% comment %} <span id="langName">{{ lang.name_local }}</span> {% endcomment %}
              </span>
          </button>
      </form>
    </a>
    <ul class="navbar-menu">
      {% for navbar_page in navbar_pages %}
        <li class="{% if navbar_page.get_children.live|length > 0 %}has-dropdown{% endif %}">
          {% if navbar_page.title != 'Tours' %}
          <a href="{{ navbar_page.url }}">{{ navbar_page.title }}</a>
          {% if navbar_page.get_children.live|length > 0 %}
            <div class="dropdown">
              <ul>
                {% for child in navbar_page.get_children.live %}
                  <li>
                    <a href="{{ child.url }}">{{ child.title }}</a>
                    {% comment %} Optional: Add sub-dropdown for second-level children (multi-level) {% endcomment %}
                    {% if child.get_children.live|length > 0 %}
                      <div class="sub-menu">
                        <ul>
                          {% for grandchild in child.get_children.live %}
                            <li><a href="{{ grandchild.url }}">{{ grandchild.title }}</a></li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {% else %}
          <a href="{{ navbar_page.url }}">{{ navbar_page.title }}</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </nav>
</header>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('languageToggle');
    const form = document.getElementById('languageForm');
    const input = document.getElementById('languageInput');
    const currentSpan = document.getElementById('currentLang');
    const flagIcon = document.getElementById('flagIcon');
    const langName = document.getElementById('langName');

    // Flag mapping (mirrors your Python filter; extend as needed)
    const flagMapping = {
        'en-us': 'us',
        'en-gb': 'gb',
        'es': 'es',
        'fr': 'fr',
        'de': 'de',
        'it': 'it',
        'is': 'is',
        'pl': 'pl',
        'pt-br': 'br',
        'pt-pt': 'pt',
        'ja': 'jp',
        'zh-hans': 'cn',  // Simplified Chinese
        'zh-hant': 'tw',  // Traditional Chinese (Taiwan)
        // Add more: 'ar': 'sa', etc. Default: 'gb'
    };

    // Current language object
    const currentLangObj = {
        code: '{{ LANGUAGE_CODE }}',
        name: '{% get_language_info for LANGUAGE_CODE as lang %}{{ lang.name_local }}'
    };

    // Build array from translations (all others)
    const otherLanguages = [
        {% if page %}
            {% for translation in page.get_translations.live %}
                {
                    code: '{{ translation.locale.language_code }}',
                    name: '{% get_language_info for translation.locale.language_code as lang %}{{ lang.name_local }}'
                },
                {% endfor %}
        {% endif %}
    ];

    // Full array: Current + others (dedupe)
    let languages = [currentLangObj, ...otherLanguages];
    const seenCodes = new Set();
    languages = languages.filter(lang => {
        if (seenCodes.has(lang.code)) return false;
        seenCodes.add(lang.code);
        return true;
    });

    // FIXED ORDER: Sort by language code (always [en, es, is])
    languages.sort((a, b) => a.code.localeCompare(b.code));

    // Log for debugging
    console.log('Current LANGUAGE_CODE:', '{{ LANGUAGE_CODE }}');
    console.log('Sorted Languages array:', languages);

    if (languages.length <= 1) {
        button.disabled = true;
        console.log('Only one language; toggle disabled.');
        return;
    }

    // Find current index in sorted array (exact match first)
    const currentCode = currentLangObj.code;
    let currentIndex = languages.findIndex(lang => lang.code === currentCode);
    if (currentIndex === -1) {
        // Fallback: Normalized (e.g., 'en-us' -> 'en')
        function normalizeCode(code) {
            return code.toLowerCase().split('-')[0];
        }
        const normalizedCurrent = normalizeCode(currentCode);
        currentIndex = languages.findIndex(lang => normalizeCode(lang.code) === normalizedCurrent);
        console.log('Exact match failed; using normalized. Index:', currentIndex);
    }
    if (currentIndex === -1) {
        currentIndex = 0;
        console.log('No match found; defaulting to index 0.');
    }

    console.log('Starting index:', currentIndex);

    // Set initial hidden input
    input.value = languages[currentIndex].code;

  // Update display (now handles flag + name)
  function updateDisplay() {
      const lang = languages[currentIndex];
      input.value = lang.code;

      if (langName) {  // Guard if somehow missing
          langName.textContent = lang.name;
      }

      // Update flag: New class format for v6+
      const flagCode = flagMapping[lang.code] || 'gb';
      flagIcon.className = `fi fi-${flagCode}`;

      console.log('Previewing:', lang.name, '(Flag:', flagCode, '; Index:', currentIndex, ')');
  }

    // Initial display update (ensures flag/name sync on load)
    updateDisplay();

    // Cycle on click
    button.addEventListener('click', function(e) {
        e.preventDefault();
        currentIndex = (currentIndex + 1) % languages.length;
        updateDisplay();

        setTimeout(() => {
            form.submit();
        }, 150);
    });
});
</script>