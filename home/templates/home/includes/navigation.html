{% load static i18n dict_tags navbar_tags custom_filters wagtailcore_tags wagtailadmin_tags lang_filters %} {% get_navbar_pages as navbar_pages %} {% wagtail_site as current_site %}

<header>
 <nav class="navbar fixed-top">
  <div class="container-fluid">
   <!-- Logo – always visible -->
   <a class="navbar-brand p-0" href="{% url 'wagtail_serve' '' %}">
    <img
     src="{% static 'default_media/logo.png' %}"
     alt="navigation bar logo"
     class="navbar-logo"
     loading="lazy"
     height="auto"
     width="auto"
    />
   </a>

   {% if request.user.is_authenticated and request.user.is_staff %}
   <div class="notification-wrapper">
    <button id="notification-bell" class="notification-bell" aria-label="Notifications">
     <i class="icon-bell"></i>
     <span id="unread-count" class="badge">{% unread_notifications_count %}</span>
    </button>

    <div id="notification-dropdown" class="notification-dropdown hidden">
     <div class="dropdown-header">
      <h4>Notifications</h4>
      <span id="dropdown-unread">0 unread</span>
     </div>
     <ul id="notification-list"></ul>
     <div class="dropdown-footer">
      <a href="{% url 'notifications:frontend_list' %}">View all Notifications</a>
     </div>
    </div>
   </div>
   {% endif %}
   <!-- Hamburger – visible only on < lg (mobile) -->
   <button
    class="navbar-toggler d-lg-none bg-white"
    type="button"
    data-bs-toggle="offcanvas"
    data-bs-target="#offcanvasNavbar"
    aria-controls="offcanvasNavbar"
    aria-label="{% trans 'Toggle navigation' %}"
   >
    <span class="navbar-toggler-icon"></span>
   </button>

   <!-- Offcanvas – only active on mobile (responsive class .offcanvas-lg hides content above lg) -->
   <div
    class="offcanvas offcanvas-end offcanvas-lg"
    tabindex="-1"
    id="offcanvasNavbar"
    aria-labelledby="offcanvasNavbarLabel"
    style="height: 100vh; max-height: 100vh"
   >
    <div class="offcanvas-header">...</div>

    <div class="offcanvas-body overflow-auto">
     <!-- key: overflow-auto enables scroll -->
     <ul class="navbar-nav justify-content-start flex-grow-1 navbar-menu pt-3 offcanvas-menu">
      <!-- Language toggle -->
      <li class="nav-item lang-toggle">
       <form action="{% url 'set_language' %}" method="post" id="languageForm" class="d-flex align-items-center mb-0">
        {% csrf_token %}
        <input type="hidden" name="language" id="languageInput" />
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <button type="button" id="languageToggle" class="nav-link btn btn-link p-0" aria-label="{% trans 'Toggle Language' %}">
         <span id="currentLang">
          {% load lang_filters %} {% get_language_info for LANGUAGE_CODE as lang %}
          <span id="flagIcon" class="fi fi-{{ LANGUAGE_CODE|language_to_flag }}" aria-hidden="true"></span>
         </span>
        </button>
       </form>
      </li>

      <!-- Pages loop -->

      {% for navbar_page in navbar_pages %} {% with children=navbar_page.get_children.live.specific %}
      <li class="nav-item {% if children %}dropdown{% endif %}">
       {% if children %}
       <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        {{ navbar_page.title }}
       </a>
       {% else %}
       <a class="nav-link" href="{{ navbar_page.url }}"> {{ navbar_page.title }} </a>
       {% endif %}
       <ul class="dropdown-menu">
        {% for child in children %}
        <li>
         <a class="dropdown-item" href="{{ child.url }}">{{ child.title }}</a>
         {% with grandkids=child.get_children.live.specific %} {% if grandkids %}
         <ul class="list-unstyled ps-4 mt-1 mb-0">
          {% for grand in grandkids %}
          <li><a class="dropdown-item" href="{{ grand.url }}">{{ grand.title }}</a></li>
          {% endfor %}
         </ul>
         {% endif %} {% endwith %}
        </li>
        {% endfor %}
       </ul>
      </li>
      {% endwith %} {% endfor %}

      <!-- Auth -->
      <li class="nav-item auth_option">
       {% if request.user.is_authenticated %}
       <a class="nav-link" href="{% url 'account_logout' %}">Logout</a>
       {% else %}
       <a class="nav-link" href="{% url 'login' %}">Login</a>
       {% endif %}
      </li>
     </ul>
    </div>
   </div>

   <!-- Desktop horizontal menu – visible ≥ lg -->
   <ul class="navbar-menu d-none d-lg-flex ms-auto align-items-center gap-3">
    <!-- Duplicate the menu content here for desktop (or use JS to avoid duplication if preferred) -->
    <!-- For simplicity and reliability, duplicate the inner content (common pattern) -->
    <!-- Language -->
    <form action="{% url 'set_language' %}" method="post" id="languageFormDesktop" class="lang-toggle ms-3">
     {% csrf_token %}
     <input type="hidden" name="language" id="languageInputDesktop" />
     <input type="hidden" name="next" value="{{ request.get_full_path }}" />
     <button type="button" id="languageToggle" class="btn btn-link p-0" aria-label="{% trans 'Toggle Language' %}">
      <span id="currentLang">
       {% get_language_info for LANGUAGE_CODE as lang %}
       <span id="flagIcon" class="fi fi-{{ LANGUAGE_CODE|language_to_flag }}" aria-hidden="true"></span>
      </span>
     </button>
    </form>

    {% for navbar_page in navbar_pages %} {% with children=navbar_page.get_children.live.specific %}
    <li class="{% if children %}has-dropdown{% endif %} ms-3">
     <a href="{{ navbar_page.url }}">{{ navbar_page.title }}</a>
     {% if children %}
     <div class="dropdown">
      <ul>
       {% for child in children %}
       <li>
        <a href="{{ child.url }}">{{ child.title }}</a>
        {% with grandkids=child.get_children.live.specific %} {% if grandkids %}
        <div class="sub-menu">
         <ul>
          {% for grand in grandkids %}
          <li><a href="{{ grand.url }}">{{ grand.title }}</a></li>
          {% endfor %}
         </ul>
        </div>
        {% endif %} {% endwith %}
       </li>
       {% endfor %}
      </ul>
     </div>
     {% endif %}
    </li>
    {% endwith %} {% endfor %}

    <li class="auth_option ms-3">
     {% if request.user.is_authenticated %}
     <a href="{% url 'account_logout' %}">Logout</a>
     {% else %}
     <a href="{% url 'login' %}">Login</a>
     {% endif %}
    </li>
   </ul>
  </div>
 </nav>
</header>
<script>
 document.addEventListener('DOMContentLoaded', function() {
     const button = document.getElementById('languageToggle');
     const form = document.getElementById('languageForm');
     const input = document.getElementById('languageInput');
     const currentSpan = document.getElementById('currentLang');
     const flagIcon = document.getElementById('flagIcon');
     const langName = document.getElementById('langName');

     // Flag mapping (mirrors your Python filter; extend as needed)
     const flagMapping = {
         'en-us': 'us',
         'en-gb': 'gb',
         'es': 'es',
         'fr': 'fr',
         'de': 'de',
         'it': 'it',
         'is': 'is',
         'pl': 'pl',
         'pt-br': 'br',
         'pt-pt': 'pt',
         'ja': 'jp',
         'zh-hans': 'cn',  // Simplified Chinese
         'zh-hant': 'tw',  // Traditional Chinese (Taiwan)
         // Add more: 'ar': 'sa', etc. Default: 'gb'
     };

     // Current language object
     const currentLangObj = {
         code: '{{ LANGUAGE_CODE }}',
         name: '{% get_language_info for LANGUAGE_CODE as lang %}{{ lang.name_local }}'
     };

     // Build array from translations (all others)
     const otherLanguages = [
         {% if page %}
             {% for translation in page.get_translations.live %}
                 {
                     code: '{{ translation.locale.language_code }}',
                     name: '{% get_language_info for translation.locale.language_code as lang %}{{ lang.name_local }}'
                 },
                 {% endfor %}
         {% endif %}
     ];

     // Full array: Current + others (dedupe)
     let languages = [currentLangObj, ...otherLanguages];
     const seenCodes = new Set();
     languages = languages.filter(lang => {
         if (seenCodes.has(lang.code)) return false;
         seenCodes.add(lang.code);
         return true;
     });

     // FIXED ORDER: Sort by language code (always [en, es, is])
     languages.sort((a, b) => a.code.localeCompare(b.code));

     // Log for debugging
     console.log('Current LANGUAGE_CODE:', '{{ LANGUAGE_CODE }}');
     console.log('Sorted Languages array:', languages);

     if (languages.length <= 1) {
         button.disabled = true;
         console.log('Only one language; toggle disabled.');
         return;
     }

     // Find current index in sorted array (exact match first)
     const currentCode = currentLangObj.code;
     let currentIndex = languages.findIndex(lang => lang.code === currentCode);
     if (currentIndex === -1) {
         // Fallback: Normalized (e.g., 'en-us' -> 'en')
         function normalizeCode(code) {
             return code.toLowerCase().split('-')[0];
         }
         const normalizedCurrent = normalizeCode(currentCode);
         currentIndex = languages.findIndex(lang => normalizeCode(lang.code) === normalizedCurrent);
         console.log('Exact match failed; using normalized. Index:', currentIndex);
     }
     if (currentIndex === -1) {
         currentIndex = 0;
         console.log('No match found; defaulting to index 0.');
     }

     console.log('Starting index:', currentIndex);

     // Set initial hidden input
     input.value = languages[currentIndex].code;

   // Update display (now handles flag + name)
   function updateDisplay() {
       const lang = languages[currentIndex];
       input.value = lang.code;

       if (langName) {  // Guard if somehow missing
           langName.textContent = lang.name;
       }

       // Update flag: New class format for v6+
       const flagCode = flagMapping[lang.code] || 'gb';
       flagIcon.className = `fi fi-${flagCode}`;

       console.log('Previewing:', lang.name, '(Flag:', flagCode, '; Index:', currentIndex, ')');
   }

     // Initial display update (ensures flag/name sync on load)
     updateDisplay();

     // Cycle on click
     button.addEventListener('click', function(e) {
         e.preventDefault();
         currentIndex = (currentIndex + 1) % languages.length;
         updateDisplay();

         setTimeout(() => {
             form.submit();
         }, 150);
     });
 });
</script>
