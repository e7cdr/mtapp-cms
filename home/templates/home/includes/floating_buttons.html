{% load static i18n wagtailcore_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/floating_buttons.css' %}" />
{% endblock %}

    <!-- WhatsApp Button -->
    <a href="https://api.whatsapp.com/send/?phone=593967359549&text=Hello%2C+Milano+Travel.&type=phone_number&app_absent=0"
       class="whatsapp-button" target="_blank" aria-label="{% trans 'Contact us on WhatsApp' %}">
        <i class="bi bi-whatsapp"></i>
    </a>

    {% comment %} <!-- Theme Toggle Button -->
    <button id="themeToggle" aria-label="{% trans 'Toggle Dark Mode' %}">
        <i class="bi bi-sun"></i>
    </button> {% endcomment %}

<!-- Language Toggle Form -->

<form action="{% url 'set_language' %}" method="post" id="languageForm" class="lang-toggle">
    {% csrf_token %}
    <input type="hidden" name="language" id="languageInput">
    <input type="hidden" name="next" value="{{ request.get_full_path }}">
    <button type="button" id="languageToggle" aria-label="{% trans 'Toggle Language' %}">
        <i class="bi bi-globe"></i>
        <span id="currentLang">
            {% get_language_info for LANGUAGE_CODE as lang %}
            {{ lang.name_local }}
        </span>
    </button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('languageToggle');
    const form = document.getElementById('languageForm');
    const input = document.getElementById('languageInput');
    const currentSpan = document.getElementById('currentLang');
    
    // Current language object
    const currentLangObj = { 
        code: '{{ LANGUAGE_CODE }}', 
        name: '{% get_language_info for LANGUAGE_CODE as lang %}{{ lang.name_local }}' 
    };
    
    // Build array from translations (all others)
    const otherLanguages = [
        {% if page %}
            {% for translation in page.get_translations.live %}
                { 
                    code: '{{ translation.locale.language_code }}', 
                    name: '{% get_language_info for translation.locale.language_code as lang %}{{ lang.name_local }}' 
                },
                {% endfor %}
        {% endif %}
    ];
    
    // Full array: Current + others (dedupe)
    let languages = [currentLangObj, ...otherLanguages];
    const seenCodes = new Set();
    languages = languages.filter(lang => {
        if (seenCodes.has(lang.code)) return false;
        seenCodes.add(lang.code);
        return true;
    });
    
    // FIXED ORDER: Sort by language code (always [en, es, is])
    languages.sort((a, b) => a.code.localeCompare(b.code));
    
    // Log for debugging
    console.log('Current LANGUAGE_CODE:', '{{ LANGUAGE_CODE }}');
    console.log('Sorted Languages array:', languages);
    
    if (languages.length <= 1) {
        button.disabled = true;
        console.log('Only one language; toggle disabled.');
        return;
    }
    
    // Find current index in sorted array (exact match first)
    const currentCode = currentLangObj.code;
    let currentIndex = languages.findIndex(lang => lang.code === currentCode);
    if (currentIndex === -1) {
        // Fallback: Normalized (e.g., 'en-us' -> 'en')
        function normalizeCode(code) {
            return code.toLowerCase().split('-')[0];
        }
        const normalizedCurrent = normalizeCode(currentCode);
        currentIndex = languages.findIndex(lang => normalizeCode(lang.code) === normalizedCurrent);
        console.log('Exact match failed; using normalized. Index:', currentIndex);
    }
    if (currentIndex === -1) {
        currentIndex = 0;
        console.log('No match found; defaulting to index 0.');
    }
    
    console.log('Starting index:', currentIndex);
    
    // Set initial hidden input
    input.value = languages[currentIndex].code;
    
    // Update display (for preview only)
    function updateDisplay() {
        const lang = languages[currentIndex];
        currentSpan.textContent = lang.name;
        input.value = lang.code;
        console.log('Previewing:', lang.name, '(Index:', currentIndex, ')');
    }
    
    // Cycle on click
    button.addEventListener('click', function(e) {
        e.preventDefault();
        currentIndex = (currentIndex + 1) % languages.length;
        updateDisplay();
        
        setTimeout(() => {
            form.submit();
        }, 150);
    });
});
</script>


{% comment %} <!-- Currency Toggle Form -->
<form id="currencyForm" class="currency-toggle">
    {% csrf_token %}
    <input type="hidden" name="currency" id="currencyInput" value="{{ currency|default:'USD' }}">
    <div class="fixed bottom-[57px] left-5 z-[1002]">
        <button type="button" id="currencyToggle" aria-label="{% trans 'Toggle Currency' %}">
            <i class="bi bi-currency-exchange"></i>
            <span class="currency">{{ currency|default:'USD' }}</span>
        </button>
        <div id="currencyDropdown" class="hidden absolute bottom-12 left-0 bg-primary/10 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg min-w-[100px] z-[1003]">
            {% for rate in exchange_rates %}
                <button type="button" class="currency-option block w-full text-left px-3 py-2 text-sm text-white dark:text-gray-100 hover:bg-primary/40 hover:text-white" data-currency="{{ rate.currency_code }}">
                    {{ rate.currency_code }}
                </button>
                <hr>
            {% endfor %}

        </div>
    </div>
</form> {% endcomment %}

